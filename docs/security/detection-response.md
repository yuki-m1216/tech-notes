# 検知と対応

このセクションでは、セキュリティイベントの検知からインシデント対応までの一連の流れについて学びます。

## このページで学ぶこと

- なぜ検知が予防と同様に重要なのか
- ログ監視の設計原則
- 効果的なアラートの設計
- インシデント対応の基本的な流れ
- AWS環境での実装パターン

---

## なぜ検知が重要か

### 予防だけでは不十分

どれほど予防策を講じても、すべての攻撃を防ぐことはできません。

- 新しい脆弱性は日々発見される
- 攻撃手法は常に進化している
- 内部脅威は境界防御では防げない
- 設定ミスや人的エラーは完全には排除できない

重要なのは「侵害は起こりうる」という前提で準備することです。

### 検知の価値

早期検知がもたらす効果：

| 検知タイミング | 影響範囲 | 対応コスト |
|--------------|---------|----------|
| 数分〜数時間 | 限定的 | 低〜中 |
| 数日〜数週間 | 広範囲に拡大 | 高 |
| 数ヶ月以上 | 全社的な影響 | 非常に高 |

### NIST CSF における位置づけ

[NIST Cybersecurity Framework](https://www.nist.gov/cyberframework) では、セキュリティ機能を5つに分類しています：

1. **Identify（特定）**: リスクの把握
2. **Protect（保護）**: 予防策の実装
3. **Detect（検知）**: セキュリティイベントの発見
4. **Respond（対応）**: インシデントへの対処
5. **Recover（復旧）**: 正常状態への回復

検知（Detect）は保護（Protect）と同等に重要な機能として位置づけられています。

---

## ログ監視の考え方

### 何をログに記録すべきか

効果的なセキュリティ監視のために、以下のイベントを記録します：

**認証・認可関連:**

- ログイン成功・失敗
- 権限変更
- 特権操作の実行
- APIキー・トークンの使用

**リソース操作:**

- リソースの作成・変更・削除
- 設定変更
- データへのアクセス

**ネットワーク:**

- 異常な通信パターン
- 拒否された接続
- 外部への大量データ転送

### 記録すべきでない情報

ログに含めてはいけない情報：

- パスワード（平文・ハッシュ問わず）
- クレジットカード番号
- 個人情報（必要最小限に）
- セッショントークンの全文
- APIシークレット

!!! warning "ログへの機密情報混入"
    アプリケーションログにリクエストボディをそのまま出力すると、意図せず機密情報が記録される可能性があります。ログ出力前のマスキング処理を検討してください。

### ログの保持期間

保持期間は以下を考慮して決定します：

| 考慮点 | 内容 |
|-------|------|
| 法規制要件 | 業界や地域による義務的な保持期間 |
| 調査に必要な期間 | 侵害検知までの平均時間 + 調査期間 |
| コスト | ストレージコストとのバランス |
| ビジネス要件 | 監査対応や内部統制の要件 |

**規制・法律による保持期間の例:**

| 規制・法律 | 保持期間 | 根拠 |
|-----------|---------|------|
| PCI DSS | 1年（直近3ヶ月はすぐ参照可能に） | [Requirement 10.7](https://pcidssguide.com/pci-dss-requirement-10/) |
| 金融商品取引法（J-SOX） | 7年 | 下記注記参照 |
| 不正アクセス禁止法（公訴時効） | 3年 | [刑事訴訟法250条2項6号](https://wakailaw.com/keiji/10866) |
| 電子計算機使用詐欺罪（時効） | 7年 | [刑法246条の2、刑事訴訟法250条2項4号](https://wakailaw.com/keiji/8334) |

!!! tip "保持期間の参考情報"
    [NIST SP 800-92](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-92.pdf)（[IPA日本語訳](https://www.ipa.go.jp/security/reports/oversea/nist/ug65p90000019cp4-att/begoj9000000bfnm.pdf)）ではログ管理のガイドラインを提供していますが、具体的な保持期間は組織の要件に委ねています。日本では業界や適用される法律によって要件が異なります。

!!! note "J-SOX 7年について"
    「金融商品取引法（J-SOX）でログ保持7年」という情報はWeb上で広く見られますが、金融商品取引法自体にログ保持期間を明示した条文は確認できていません。[法人税法施行規則59条](https://www.nta.go.jp/taxes/shiraberu/taxanswer/hojin/5930.htm)の帳簿書類7年保存との混同の可能性があります。金融業界での要件は、所管の規制当局やコンプライアンス部門に確認してください。

### ログの改ざん防止

ログの信頼性を確保するために：

- **書き込み専用**: ログ生成元からは削除・変更不可に
- **別アカウントへの保存**: 侵害されたアカウントからアクセス不可に
- **整合性検証**: ハッシュによる改ざん検知

---

## 異常検知とアラート

### 検知のアプローチ

**1. ルールベース検知**

既知のパターンに基づいて検知します：

```
例: 同一IPから10分間で100回以上のログイン失敗
例: 営業時間外の特権操作
例: 許可されていないリージョンでのリソース作成
```

- メリット: 明確、誤検知が少ない
- デメリット: 未知の攻撃パターンは検知できない

**2. ベースライン検知（アノマリ検知）**

通常の行動パターンからの逸脱を検知します：

```
例: 通常の10倍のデータ転送量
例: 初めてアクセスするリソース
例: 過去に使用されたことのない地域からのアクセス
```

- メリット: 未知の攻撃も検知可能
- デメリット: 誤検知が多くなりがち

**3. 脅威インテリジェンス**

既知の脅威情報（悪意のあるIP、ドメイン等）と照合します。

### アラート疲れを防ぐ

大量のアラートは「アラート疲れ」を引き起こし、重要なアラートを見逃す原因になります。

**アラート設計の原則:**

- **対応可能なものだけアラート**: 情報提供だけのログはアラートにしない
- **重複排除**: 同一事象の繰り返しアラートを抑制
- **重大度の明確化**: Critical / High / Medium / Low を適切に設定
- **コンテキストの付与**: 対応に必要な情報をアラートに含める

!!! tip "効果的なアラートの条件"
    良いアラートは以下を満たします：

    - **Actionable**: 何をすべきか明確
    - **Timely**: 適切なタイミングで通知
    - **Contextual**: 判断に必要な情報が含まれる
    - **Prioritized**: 重要度が明確

### 相関分析

単一のイベントでは判断できないことも、複数のイベントを組み合わせると脅威が見えてきます：

```
単独では低リスク:
  ・ログイン失敗 5回
  ・新しいAPIキーの作成
  ・S3バケットへのアクセス

組み合わせると高リスク:
  同一ユーザーが短時間で上記すべてを実行
  → アカウント侵害の可能性
```

---

## インシデント対応

### なぜ事前準備が必要か

インシデント発生時は、時間的プレッシャーの中で多くの判断を迫られます。

事前準備なしの場合：

- 誰が対応するのか不明
- 何を優先すべきか判断できない
- コミュニケーションが混乱
- 対応の遅れが被害を拡大

**インシデント対応計画は「訓練」であり、実際のインシデント時に初めて作成するものではありません。**

### インシデント対応の流れ

[NIST SP 800-61](https://nvlpubs.nist.gov/nistpubs/specialpublications/nist.sp.800-61r2.pdf) に基づく標準的なフェーズ：

```
┌─────────────────────────────────────────────────────┐
│  1. 準備 (Preparation)                              │
│     ・対応計画の策定                                 │
│     ・ツール・権限の準備                             │
│     ・訓練の実施                                     │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│  2. 検知と分析 (Detection & Analysis)               │
│     ・アラートのトリアージ                           │
│     ・影響範囲の特定                                 │
│     ・インシデントの分類                             │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│  3. 封じ込め・根絶・復旧                            │
│    (Containment, Eradication & Recovery)            │
│     ・被害拡大の防止                                 │
│     ・脅威の除去                                     │
│     ・正常状態への復旧                               │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│  4. 事後対応 (Post-Incident Activity)               │
│     ・振り返り（ポストモーテム）                     │
│     ・改善策の実施                                   │
│     ・ドキュメントの更新                             │
└─────────────────────────────────────────────────────┘
```

### 準備フェーズで決めておくこと

**役割と責任:**

| 役割 | 責任 |
|-----|------|
| インシデントマネージャー | 全体の調整、意思決定 |
| 技術リード | 技術的な調査と対応 |
| コミュニケーション担当 | 社内外への連絡 |
| 記録係 | タイムラインと対応の記録 |

**エスカレーション基準:**

- どのような場合に経営層へ報告するか
- 外部（法執行機関、専門家）への連絡基準
- 顧客への通知が必要な条件

**事前に準備しておくもの:**

- 調査用の権限とツール
- 連絡先リスト（休日・夜間含む）
- 外部専門家との契約（リテイナー）
- ランブック（対応手順書）

### 封じ込めの判断

封じ込めでは「被害拡大の防止」と「証拠保全」のバランスを取ります：

| 対応 | メリット | デメリット |
|-----|---------|----------|
| サーバー即時停止 | 被害拡大を即座に止められる | 証拠が失われる可能性 |
| ネットワーク隔離 | 横展開を防止、調査可能 | サービス影響が出る |
| 監視継続 | 攻撃者の行動を把握 | 被害が拡大するリスク |

!!! note "証拠保全の重要性"
    後の調査や法的対応のために、可能な限り証拠を保全してください。特にメモリダンプやログは、システムを停止すると失われる可能性があります。

### 事後対応（ポストモーテム）

インシデント収束後の振り返りは、再発防止のために極めて重要です。

**ポストモーテムで確認すること:**

- 何が起きたか（タイムライン）
- なぜ検知できたか / できなかったか
- 対応は適切だったか
- 何を改善すべきか

**blame-free culture（非難しない文化）:**

個人を責めるのではなく、システムやプロセスの改善に焦点を当てます。ミスを報告しやすい環境がセキュリティを向上させます。

---

## AWS環境での実装パターン

### 主要サービスの役割分担

| サービス | 役割 | 特徴 |
|---------|------|------|
| CloudTrail | API操作の記録 | 誰が何をしたかの証跡 |
| GuardDuty | 脅威検知 | 機械学習による異常検知 |
| Security Hub | 統合ダッシュボード | 複数サービスの集約 |
| CloudWatch Logs | アプリケーションログ | カスタムメトリクス・アラート |
| Config | 構成変更の追跡 | コンプライアンスチェック |

### CloudTrail の設計

**必須の設定:**

- 全リージョンで有効化
- 管理イベントとデータイベントの記録
- ログファイルの整合性検証を有効化
- S3への保存（別アカウント推奨）

**ログ保護のベストプラクティス:**

```
本番アカウント                    ログ集約アカウント
┌─────────────┐                 ┌─────────────────┐
│ CloudTrail  │ ──────────────► │ S3バケット      │
│             │                 │ ・バージョニング │
│             │                 │ ・オブジェクト   │
│             │                 │   ロック        │
│             │                 │ ・MFA Delete    │
└─────────────┘                 └─────────────────┘
```

別アカウントに保存することで、本番アカウントが侵害されてもログを保護できます。

### GuardDuty の活用

GuardDuty は以下のデータソースを分析して脅威を検知します：

- CloudTrail イベント
- VPC フローログ
- DNS ログ

**検知される脅威の例:**

| 検知タイプ | 内容 |
|-----------|------|
| UnauthorizedAccess | 異常なAPIアクティビティ |
| Recon | 偵察活動の検知 |
| Trojan | マルウェア通信の検知 |
| CryptoCurrency | 暗号通貨マイニング |

!!! tip "GuardDuty の導入"
    GuardDuty は有効化するだけで動作を開始します。まずは有効化して、検出結果を確認することから始めてください。

### Security Hub による統合

Security Hub は複数のセキュリティサービスの結果を統合します：

```
┌─────────────┐
│ GuardDuty   │───┐
└─────────────┘   │
┌─────────────┐   │    ┌─────────────────┐
│ Inspector   │───┼───►│  Security Hub   │───► アラート
└─────────────┘   │    │  ・統合ビュー    │
┌─────────────┐   │    │  ・重大度分類    │
│ Config      │───┤    │  ・自動修復連携  │
└─────────────┘   │    └─────────────────┘
┌─────────────┐   │
│ IAM Access  │───┘
│ Analyzer    │
└─────────────┘
```

**セキュリティ標準:**

Security Hub は以下の標準に基づいたチェックを提供します：

- AWS Foundational Security Best Practices
- CIS AWS Foundations Benchmark
- PCI DSS

### アラート設計の例

**CloudWatch Alarm の活用:**

```
重要なアラート例:
・ルートアカウントの使用
・IAMポリシーの変更
・セキュリティグループの変更（0.0.0.0/0許可）
・CloudTrailの停止・変更
・S3バケットポリシーの公開設定
```

**EventBridge + SNS によるアラート:**

```
CloudTrail → EventBridge → SNS → 通知先
             (ルール)       (トピック)  ・Slack
                                       ・PagerDuty
                                       ・Email
```

### インシデント対応を支援するサービス

| サービス | 用途 |
|---------|------|
| AWS Systems Manager | リモートでの調査・対応 |
| Amazon Detective | GuardDuty検出結果の調査・可視化 |
| AWS Backup | 復旧用バックアップ |
| AWS Organizations SCP | 緊急時のアクセス制限 |

### よくある失敗パターン

!!! failure "失敗例1: CloudTrailが一部リージョンでしか有効でない"
    ```
    ❌ 使用しているリージョンのみCloudTrailを有効化

    ✅ 全リージョンで有効化（使用していないリージョンでの
       不正活動も検知するため）
    ```

!!! failure "失敗例2: アラートが多すぎて対応できない"
    ```
    ❌ すべての検知結果をアラートとして通知

    ✅ 重大度に応じて通知先を分ける
       ・Critical: 即時対応（PagerDuty等）
       ・High: 当日対応（Slack通知）
       ・Medium/Low: 定期レビュー
    ```

!!! failure "失敗例3: インシデント対応計画がない"
    ```
    ❌ インシデント発生時に初めて対応を検討

    ✅ 事前に対応計画を策定し、定期的に訓練
       ・役割分担の明確化
       ・連絡先リストの整備
       ・ランブックの作成
    ```

---

## まとめ

検知と対応の要点：

1. **予防と検知は両輪**: 侵害は起こりうる前提で、早期検知の仕組みを整備
2. **適切なログ設計**: 必要な情報を記録し、機密情報は含めない
3. **アラート疲れの防止**: 対応可能で重要なアラートに絞る
4. **事前準備の重要性**: インシデント対応計画は訓練として事前に策定
5. **継続的な改善**: ポストモーテムを通じてプロセスを改善

検知と対応は「完璧な予防ができない」ことを認めた上での現実的なアプローチです。早期に検知し、適切に対応することで、被害を最小限に抑えることができます。

[セキュアな開発と脆弱性管理を学ぶ →](secure-development.md){ .md-button }
