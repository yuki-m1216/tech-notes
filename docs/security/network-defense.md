# ネットワーク防御

このセクションでは、ネットワーク層での多層的な防御の考え方について学びます。

## このページで学ぶこと

- ネットワーク分離の目的と設計原則
- ファイアウォールの種類と適切な使い分け
- アプリケーション層での防御の必要性
- AWS環境での実践的な設計パターン

---

## ネットワーク分離の考え方

### なぜネットワークを分離するのか

ネットワーク分離の目的は「**攻撃の影響範囲を限定する**」ことです。

すべてのシステムが同一ネットワーク上にある場合、1つのシステムが侵害されると、攻撃者はネットワーク内を自由に移動（ラテラルムーブメント）できます。ネットワークを分離することで：

- **侵害の封じ込め**: 攻撃者の移動範囲を制限
- **重要システムの保護**: データベースや認証サーバーを外部から隔離
- **監視の効率化**: セグメント間の通信を監視ポイントとして活用

### Public vs Private サブネットの使い分け

ネットワーク分離の最も基本的なパターンです。

| サブネット | 特徴 | 配置するもの |
|---|---|---|
| Public | インターネットと直接通信可能 | ロードバランサー、踏み台サーバー、NAT Gateway |
| Private | インターネットから直接アクセス不可 | アプリケーションサーバー、データベース、内部API |

**原則: インターネットに公開する必要がないものはPrivateサブネットに配置する**

```
インターネット
     │
     ▼
┌─────────────────────────────────┐
│  Public Subnet                  │
│  ・ALB（ロードバランサー）      │
└─────────────────────────────────┘
     │（内部通信のみ）
     ▼
┌─────────────────────────────────┐
│  Private Subnet                 │
│  ・EC2/ECS（アプリケーション）  │
│  ・RDS（データベース）          │
│  ・ElastiCache                  │
└─────────────────────────────────┘
```

### マイクロセグメンテーション

従来の境界防御（Perimeter Security）では、ネットワークの「内側」と「外側」を分ける境界を設けていました。しかし、一度境界を突破されると内部は無防備になります。

**マイクロセグメンテーション**は、より細かい単位でネットワークを分離する考え方です：

- アプリケーションごとに分離
- データの機密性レベルごとに分離

!!! note "環境分離について"
    開発・ステージング・本番などの環境分離は、AWSではアカウントレベルでの分離が推奨されています（AWS Organizations、Control Tower等）。マイクロセグメンテーションは主に同一環境内での細かい分離を指します。

**AWSでの実現方法:**

AWSでマイクロセグメンテーションを実現するには、主に2つのアプローチがあります。

**方法1: Security Groupによる制御（同一サブネット内）**

```
Private Subnet
├── Webアプリケーション (web-app-sg: ALBからの80/443のみ許可)
├── APIサーバー (api-sg: web-app-sgからのみ許可)
└── データベース (db-sg: api-sgからの3306のみ許可)
```

同一サブネット内でもSecurity Groupで通信を制御できます。シンプルな構成で、サブネット数を抑えられます。

**方法2: サブネット分離 + Security Group（より厳密な分離）**

```
VPC: 本番環境
├── Private Subnet: Webアプリケーション層
│   └── web-app-sg（ALBからの80/443のみ許可）
├── Private Subnet: APIサーバー層
│   └── api-sg（web-app-sgからのみ許可）
└── Private Subnet: データベース層
    └── db-sg（api-sgからの3306のみ許可）
```

サブネットを分離することで、Network ACLによる追加の制御や、ルートテーブルによる経路制御も可能になります。

どちらの方法でも、各層は必要な通信のみを許可し、データベースはAPIサーバーからしかアクセスできません。

### ゼロトラストとネットワーク分離

ゼロトラストの考え方では「ネットワークの内側にいる＝信頼できる」という前提を捨てます。

しかし、これはネットワーク分離が不要という意味ではありません。**ゼロトラストとネットワーク分離は補完関係**にあります：

- **ネットワーク分離**: 攻撃の到達範囲を物理的・論理的に制限
- **ゼロトラスト**: 到達できたとしてもアクセスには認証・認可が必要

両方を組み合わせることで、多層的な防御（Defense in Depth）を実現します。

---

## ファイアウォール設計

### ステートフル vs ステートレス

ファイアウォールには大きく2つの方式があります。

| 方式 | 特徴 | AWS例 |
|---|---|---|
| **ステートフル** | 接続状態を追跡。戻りの通信は自動許可 | Security Group |
| **ステートレス** | 各パケットを独立して評価。戻りも明示的に許可が必要 | Network ACL |

**ステートフルの動作:**
```
1. 内部サーバー → 外部API (アウトバウンド許可)
2. 外部API → 内部サーバー (戻り通信 → 自動許可)
```

**ステートレスの動作:**
```
1. 内部サーバー → 外部API (アウトバウンドルールで許可)
2. 外部API → 内部サーバー (インバウンドルールで明示的に許可が必要)
```

### Security Group vs Network ACL の使い分け

AWSでは両方を適材適所で使い分けます。

| 観点 | Security Group | Network ACL |
|---|---|---|
| 適用対象 | ENI（リソース単位） | サブネット単位 |
| 方式 | ステートフル | ステートレス |
| ルール | 許可のみ | 許可と拒否 |
| 評価順序 | すべてのルールを評価 | 番号順に評価、最初にマッチしたルールを適用 |
| 主な用途 | リソース間のアクセス制御 | サブネット境界での粗いフィルタリング |

**使い分けの指針:**

- **Security Group**: メインのアクセス制御。リソースごとに細かく設定
- **Network ACL**: 追加の防御層。特定IPの一括拒否など、サブネット単位での制御

```
Network ACL（サブネット境界）
  └── 悪意のあるIPアドレス帯を一括拒否

Security Group（リソース単位）
  └── アプリケーション間の細かいアクセス制御
```

### 最小権限の原則をネットワークに適用する

アクセス制御の最小権限の原則は、ネットワークにも適用されます。

**アンチパターン:**

```
❌ Security Group:
   Inbound: 0.0.0.0/0 からのすべてのトラフィックを許可
   Outbound: 0.0.0.0/0 へのすべてのトラフィックを許可
```

**推奨パターン:**

```
✅ Security Group (web-app-sg):
   Inbound: alb-sg からの 8080 のみ許可
   Outbound: api-sg への 443、db-sg への 3306 のみ許可
```

!!! tip "Security Groupの参照機能を活用する"
    IPアドレスではなく、Security Groupを参照することで：

    - IPアドレスの変更に強くなる
    - オートスケーリングに対応できる
    - 意図が明確になる（「このSGを持つリソースからのみ許可」）

### インバウンドとアウトバウンド両方を考える

インバウンド（外部→内部）の制限は意識しやすいですが、**アウトバウンド（内部→外部）の制限も重要**です。

アウトバウンドを制限する理由：

- **データ漏洩の防止**: 侵害されたサーバーから外部へのデータ送信を制限
- **C2通信のブロック**: マルウェアの指令サーバーへの通信を制限
- **意図しない依存の発見**: 本来不要な外部通信を可視化

**AWSでの例:**

```
Private Subnet のサーバー:
  Outbound:
    ✅ VPCエンドポイント経由でS3へアクセス
    ✅ VPCエンドポイント経由でSecrets Managerへアクセス
    ✅ NAT Gateway経由で特定のAPIエンドポイントへアクセス
    ❌ その他のインターネット通信は拒否
```

---

## アプリケーション層の防御

!!! info "OSI参照モデルについて"
    このセクションではL3/L4/L7などの表記が登場します。これは[OSI参照モデル](https://ja.wikipedia.org/wiki/OSI%E5%8F%82%E7%85%A7%E3%83%A2%E3%83%87%E3%83%AB)のレイヤーを指します。L3はネットワーク層（IP）、L4はトランスポート層（TCP/UDP）、L7はアプリケーション層（HTTP等）です。

### なぜネットワーク層だけでは不十分か

ネットワークファイアウォールは、主にIPアドレスとポート番号で通信を制御します。しかし、正規のポート（80/443）を通る攻撃は検知できません。

```
正規のHTTPSリクエストに見える攻撃:
POST /api/users HTTP/1.1
Content-Type: application/json

{"name": "'; DROP TABLE users; --"}  ← SQLインジェクション
```

この攻撃は443ポートの正規HTTPSトラフィックなので、ネットワークファイアウォールでは防げません。

### WAF（Web Application Firewall）の役割

WAFはアプリケーション層（L7）で通信の中身を検査します。

**WAFが検知・防御できる攻撃例:**

| 攻撃 | 概要 |
|---|---|
| SQLインジェクション | SQL文を注入してデータベースを操作 |
| クロスサイトスクリプティング（XSS） | 悪意のあるスクリプトを埋め込む |
| パストラバーサル | `../` を使って意図しないファイルにアクセス |
| HTTPリクエストスマグリング | HTTPパーサーの差異を悪用 |

**AWS WAFの構成例:**

```
インターネット → AWS WAF → ALB → アプリケーション
                   │
                   └── マネージドルールで既知の攻撃パターンをブロック
                       ・AWS マネージドルール（Core rule set）
                       ・SQLインジェクション対策ルール
                       ・カスタムルール（ビジネスロジック保護）
```

!!! warning "WAFは万能ではない"
    WAFはシグネチャベースの検知が中心です。以下の点に注意：

    - **新しい攻撃手法**: シグネチャが更新されるまで検知できない
    - **ビジネスロジックの脆弱性**: 正規のリクエストに見える不正操作は検知困難
    - **暗号化された通信の内部**: TLS終端前の通信は検査できない

    WAFは**多層防御の一つ**として位置づけ、アプリケーション側でのバリデーションも必須です。

### DDoS攻撃への対策

DDoS（Distributed Denial of Service）攻撃は、大量のリクエストでサービスを過負荷にする攻撃です。

**DDoS攻撃の種類:**

| レイヤー | 攻撃例 | 対策 |
|---|---|---|
| L3/L4（ネットワーク層） | SYN Flood、UDP Flood | AWS Shield、ネットワークACL |
| L7（アプリケーション層） | HTTP Flood、Slowloris | WAF、レート制限 |

**AWSでの防御:**

- **AWS Shield Standard**: すべてのAWSリソースに無料で適用。L3/L4攻撃を自動防御
- **AWS Shield Advanced**: より高度な保護、DDoSコスト保護、専門チームのサポート
- **CloudFront + WAF**: エッジでの防御によりオリジンへの負荷を軽減

### レート制限の重要性

レート制限は、単位時間あたりのリクエスト数を制限する仕組みです。

**レート制限の効果:**

- **DDoS緩和**: 異常な量のリクエストを制限
- **ブルートフォース対策**: ログイン試行回数を制限
- **API乱用防止**: 過剰なAPI呼び出しを制限
- **コスト管理**: 意図しない大量アクセスによるコスト増を防止

**AWS WAFでのレート制限例:**

```
ルール: 同一IPから5分間で1000リクエストを超えたらブロック

追加条件の例:
- /login エンドポイントは5分間で10リクエストまで
- /api/search は5分間で100リクエストまで
```

---

## AWS環境での実装パターン

### VPC設計の基本原則

**1. 適切なCIDRブロックの設計**

CIDRブロックのサイズは要件に応じて決定します。AWSは具体的な推奨サイズを明示していませんが、以下のガイドラインを示しています：

- **VPC**: `/16`（65,536アドレス）〜 `/28`（16アドレス）の範囲で設定可能
- **サブネット**: 各サブネットで5個のIPアドレスがAWSに予約される
- 成長予測が不明な場合は大きめを選択（後からの再構成を避けるため）
- ただし過度に大きいとピアリング時に重複問題が発生する可能性

!!! tip "CIDR設計のポイント"
    - 将来の拡張を見越して余裕を持ったサイズに
    - オンプレミスや他VPCとのピアリングを考慮し、CIDRが重複しないように
    - 各サブネットの用途を明確に（命名規則も重要）
    - 一時的なワークロード（Auto Scaling、Kubernetesポッド等）のIP需要も考慮

    詳細は [VPC CIDR blocks](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-cidr-blocks.html) および [Subnet sizing](https://docs.aws.amazon.com/vpc/latest/userguide/subnet-sizing.html) を参照してください。設計例については [AWS Black Belt - Amazon VPC](https://d1.awsstatic.com/webinars/jp/pdf/services/20201021_AWS-BlackBelt-VPC.pdf) も参考になります。CIDR設計の検討には [AWS Subnet Calculator](https://v2.awssubnetcalculator.com/) が便利です。

**2. 可用性を考慮したマルチAZ構成**

```
リージョン
├── AZ-a
│   ├── Public Subnet (NAT Gateway, ALB)
│   ├── Private Subnet (アプリ)
│   └── DB Subnet (RDS Primary)
└── AZ-c
    ├── Public Subnet (NAT Gateway, ALB)
    ├── Private Subnet (アプリ)
    └── DB Subnet (RDS Standby)
```

### VPCエンドポイントとPrivateLink

パブリックIPアドレスを使用せずにAWSサービスにアクセスする仕組みです。

!!! note "AWS内部通信について"
    [Amazon VPC FAQ](https://aws.amazon.com/vpc/faqs/) によると、パブリックIPアドレスを使用した場合でも、AWS内部の通信はAWSプライベートネットワークを経由します（"When using public IP addresses, all communication between instances and services hosted in AWS use AWS's private network."）。VPCエンドポイントのメリットは「パブリックインターネットを経由しない」ことではなく、以下の点にあります。

**なぜVPCエンドポイントを使うのか:**

- **攻撃対象領域の削減**: インターネットゲートウェイやNATゲートウェイが不要になり、パブリックIPアドレスも不要
- **詳細なアクセス制御**: エンドポイントポリシーとセキュリティグループで細かく制御可能
- **コスト削減**: NAT Gatewayを経由しないためデータ転送料金を削減（Gateway Endpointは無料）

詳細は [AWS PrivateLink concepts](https://docs.aws.amazon.com/vpc/latest/privatelink/concepts.html) を参照してください。

**エンドポイントの種類:**

| 種類 | 特徴 | 対象サービス例 |
|---|---|---|
| ゲートウェイ型 | ルートテーブルで制御、無料 | S3, DynamoDB |
| インターフェース型 | ENIとして作成、時間課金 | その他多数のサービス |

**実装例:**

```
Private Subnet のアプリケーション
  │
  ├── S3 → ゲートウェイエンドポイント経由（NAT不要、無料）
  ├── Secrets Manager → インターフェースエンドポイント経由
  ├── ECR → インターフェースエンドポイント経由
  └── CloudWatch Logs → インターフェースエンドポイント経由

インターネットアクセスが不要なら、NAT Gatewayも削除可能
```

### インターネット接続の設計パターン

ここでは理解を助けるための構成例を紹介します。実際の設計は要件に応じて検討してください。

**パターン1: ALB + NAT Gateway**

| 通信方向 | 経路 | 用途 |
|---------|------|------|
| インバウンド | Internet → ALB → EC2/ECS | ユーザーからのHTTPSリクエスト |
| アウトバウンド | EC2/ECS → NAT Gateway → Internet | 外部API呼び出し、パッケージ更新等 |

```
Public Subnet:  ALB, NAT Gateway
Private Subnet: EC2/ECS

【インバウンド】  Internet → ALB (Public) → EC2/ECS (Private)
【アウトバウンド】 EC2/ECS (Private) → NAT Gateway (Public) → Internet
```

NAT Gatewayはアウトバウンド専用です。外部からのインバウンド通信はALB経由で受け付けます。

**パターン2: VPCエンドポイント中心（セキュリティ重視）**

```
┌─────────────────┐
│ Private Subnet  │
│ ・Lambda/ECS    │
│                 │
│ VPC Endpoints:  │
│ ・S3            │──► AWSサービスへはエンドポイント経由
│ ・DynamoDB      │
│ ・Secrets Mgr   │
└─────────────────┘
（NAT Gateway不要、インターネット接続なし）
```

**パターン3: CloudFront + ALB（グローバル配信）**

```
User → CloudFront → ALB (Public) → ECS (Private)
         │
         └── エッジでキャッシュ、WAF、DDoS防御
```

### よくある失敗パターン

!!! failure "失敗例1: Security Groupで 0.0.0.0/0 を許可"
    ```
    ❌ Inbound: 0.0.0.0/0 から 22 (SSH) を許可

    ✅ 踏み台サーバー経由、またはSession Manager経由でアクセス
       Security Groupは踏み台のSGまたは完全にクローズ
    ```

    SSHポートを全世界に公開すると、ブルートフォース攻撃の標的になります。

!!! failure "失敗例2: すべてのサービスにパブリックIPを付与"
    ```
    ❌ RDSにパブリックアクセスを許可
    ❌ EC2にパブリックIPを付与してPublic Subnetに配置

    ✅ データベースは必ずPrivate Subnet
    ✅ アプリケーションサーバーもPrivate Subnetが基本
    ```

    パブリックIPは必要最小限のリソースのみに付与してください。

!!! failure "失敗例3: アウトバウンド通信を制限していない"
    ```
    ❌ Security GroupのアウトバウンドをAll traffic許可のまま放置

    ✅ 必要な通信先のみ許可（AWSサービス、特定のAPI等）
    ✅ VPCエンドポイントを活用してインターネット経由を減らす
    ```

    侵害時のデータ漏洩やC2通信を制限するため、アウトバウンドも最小権限で設計してください。

!!! failure "失敗例4: セキュリティグループのルールが肥大化"
    ```
    ❌ 1つのSGに数十のルールが追加され、何が許可されているか把握困難
    ❌ 不要になったルールが削除されずに残存

    ✅ 用途ごとにSGを分割し、組み合わせて使用
    ✅ 定期的にルールを棚卸しし、不要なルールを削除
    ```

    管理不能なSGは設定ミスや過剰な許可の温床になります。

---

## まとめ

ネットワーク防御の要点：

1. **ネットワーク分離**: Public/Privateサブネットの使い分け、マイクロセグメンテーションで攻撃範囲を限定
2. **多層的なファイアウォール**: Security Group（リソース単位）とNetwork ACL（サブネット単位）を組み合わせる
3. **最小権限の原則**: 必要な通信のみを許可。インバウンドだけでなくアウトバウンドも制限
4. **アプリケーション層の防御**: WAFによるL7防御、レート制限によるDDoS緩和
5. **VPCエンドポイントの活用**: 攻撃対象領域の削減と詳細なアクセス制御

ネットワーク防御は「境界を守る」だけでなく、「侵害を前提として被害を最小化する」設計が重要です。

[検知と対応を学ぶ →](detection-response.md){ .md-button }
