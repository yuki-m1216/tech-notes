# アクセス制御とデータ保護

「誰が」「何に」アクセスできるか、そしてデータをどのように保護するかについて学びます。

## 認証と認可の基礎

### 認証 (Authentication) と認可 (Authorization) の違い

セキュリティにおいて最も基本的な概念の一つが、認証と認可の区別です。

| 概念 | 質問 | 例 |
|---|---|---|
| **認証** | あなたは誰ですか？ | ログイン、パスワード確認、MFA |
| **認可** | あなたは何ができますか？ | 権限チェック、アクセス制御 |

この区別が重要な理由:

- **認証の失敗**: 攻撃者がシステムに侵入できる
- **認可の失敗**: 正規ユーザーが不適切なリソースにアクセスできる

どちらか一方だけでは不十分であり、両方を適切に実装する必要があります。

### 認証・認可の失敗がもたらすリスク

認証・認可の失敗は、OWASP Top 10でも上位に位置する深刻なリスクです:

- **データ漏洩**: 機密情報への不正アクセス
- **権限昇格**: 一般ユーザーが管理者権限を取得
- **なりすまし**: 他のユーザーとして操作
- **監査の無効化**: 誰が何をしたか追跡不能

## 認証の考え方

### 多要素認証 (MFA) の重要性

パスワードだけでは不十分な理由:

- パスワードは漏洩する（フィッシング、データベース侵害）
- パスワードは推測される（辞書攻撃、ブルートフォース）
- パスワードは使い回される

MFAは異なる種類の認証要素を組み合わせることで、認証の強度を高めます。

**認証の3要素:**

| 要素 | 説明 | 例 |
|---|---|---|
| 知っているもの | 記憶に基づく情報 | パスワード、PIN、秘密の質問 |
| 持っているもの | 物理的に所有するもの | スマホアプリ、ハードウェアトークン、ICカード |
| 本人であるもの | 生体情報 | 指紋、顔認証、虹彩 |

**多要素認証 vs 多段階認証:**

- **多要素認証 (MFA)**: 異なる種類の要素を組み合わせる（パスワード[知識] + スマホアプリ[所持]）
- **多段階認証**: 同じ種類の要素を複数回使う（パスワード[知識] + 秘密の質問[知識]）

多段階認証は同じ種類の攻撃（例: フィッシング）で両方突破される可能性があるため、多要素認証のほうがセキュリティ強度が高くなります。

MFAはすべてのアカウントで必須です。特に特権アカウント（管理者、rootユーザー）では絶対に省略してはなりません。

### セッション管理のベストプラクティス

認証後のセッション管理も重要なセキュリティ要素です:

- **セッションの有効期限**: 長すぎず、短すぎず（業務に支障がない範囲で短く）
- **アイドルタイムアウト**: 一定時間操作がない場合は再認証を要求
- **セッションの無効化**: ログアウト時、パスワード変更時に確実に無効化
- **同時セッション制限**: 必要に応じて同時ログイン数を制限

### フェデレーション認証の利点

フェデレーション認証とは、信頼関係を結んだ複数のシステム間で認証情報を共有する仕組みです。ユーザーは一度認証すれば、連携している他のシステムにも追加の認証なしでアクセスできます。

**身近な例:**

- 「Googleでログイン」「GitHubでログイン」ボタン
- 社内のActive DirectoryでAWSマネジメントコンソールにログイン
- Oktaなどの IDaaS で複数のSaaSアプリケーションに一度のログインでアクセス

複数のシステムで個別に認証情報を管理するのは:

- 管理負荷が高い
- パスワードの使い回しを招く
- 退職時のアカウント削除漏れが発生しやすい

フェデレーション認証（SAML、OIDC）により、ID管理を一元化できます。

## 認可の考え方

### 最小権限の原則の実践

最小権限の原則とは:

> 必要な権限だけを、必要な期間だけ、必要な範囲に付与する

**実践のポイント:**

```
❌ 悪い例: 「とりあえずAdmin権限を付与」
✅ 良い例: 「S3の特定バケットへの読み取り権限のみ付与」
```

最小権限を実現するための考え方:

1. **デフォルトは拒否**: 明示的に許可されていないものは拒否
2. **必要なものだけ許可**: 業務に必要な権限を明確にしてから付与
3. **定期的な見直し**: 不要になった権限は削除

### RBAC vs ABAC

権限管理には主に2つのアプローチがあります:

**RBAC (Role-Based Access Control)**

- ロール（役割）に権限を紐付け、ユーザーにロールを割り当てる
- シンプルで理解しやすい
- 組織構造が明確な場合に適している

```
# AWS例: IAMロールによるRBAC
「開発者」ロール → 開発環境のEC2、S3へのアクセス権限
「運用者」ロール → 本番環境の読み取り権限 + CloudWatch権限
```

**ABAC (Attribute-Based Access Control)**

- ユーザー、リソース、環境の属性に基づいて権限を判断
- より細かい制御が可能
- 複雑な要件に対応できる

```
# AWS例: タグベースのABAC
Condition: リソースタグ「Project」= ユーザータグ「Project」
→ 同じプロジェクトのリソースのみアクセス可能
```

**選択の指針:**

- シンプルな要件 → RBAC
- 複雑な条件分岐が必要 → ABAC
- 多くの場合、RBACから始めて必要に応じてABACを追加

### 一時的な権限昇格

常に高い権限を持つことはリスクです。必要なときだけ権限を昇格させる考え方:

- **Just-In-Time (JIT) アクセス**: 必要なときに申請して一時的に権限を取得
- **承認ワークフロー**: 権限昇格には上長や別チームの承認を必要とする
- **自動失効**: 一定時間後に自動的に権限を失効

**AWSでの実務例:**

- **IAM Identity Center**: 普段は「ReadOnly」権限で作業し、変更時のみ「Administrator」権限セットに切り替え
- **AssumeRole**: 本番環境の操作が必要なときだけ高権限ロールを引き受ける（セッション有効期限あり）

これにより、高権限アカウントが常時存在するリスクを軽減できます。

!!! warning "見落としやすい間接的な権限昇格リスク"
    一見限定的に見える権限でも、間接的に高権限を行使できる場合があります:

    - **IAM権限を持つユーザー**: 自分自身に権限を追加できる = 実質的なAdmin
    - **CI/CDパイプラインの実行権限**: パイプラインに付与された高権限ロールを間接的に利用できる
    - **CloudFormation/Terraform実行権限**: インフラ定義を変更することで任意のリソースを作成可能
    - **iam:PassRole権限**: 他のサービスに任意のロールを渡せる = そのロールの権限を間接的に行使

    これらの権限は「Admin権限を直接付与していないから安全」とは言えません。権限設計時には間接的な昇格パスも考慮が必要です。

### 権限の定期的な見直し

権限は時間とともに陳腐化します:

- 異動したが、旧部署の権限が残っている
- プロジェクトが終了したが、アクセス権が残っている
- 一時的に付与した権限が恒久化している

**定期的なレビューの実施:**

- 四半期ごとの権限棚卸し
- 未使用権限の自動検出と削除
- 退職・異動時の権限削除プロセスの明確化

## データ保護のための暗号化

### 暗号化で守れるもの、守れないもの

暗号化は万能ではありません。何から守れるかを理解することが重要です:

**暗号化で守れるもの:**

- 物理的な盗難（ディスクが盗まれても中身は読めない）
- ネットワーク上の盗聴（通信内容を傍受されても解読できない）
- 不正なストレージアクセス（直接データファイルにアクセスされても読めない）

**暗号化で守れないもの:**

- 認可されたユーザーによる不正利用
- 復号後のデータへの攻撃
- 鍵が漏洩した場合の攻撃
- アプリケーションの脆弱性を突いた攻撃

### 保管時の暗号化 (Encryption at Rest)

データが保存されている状態での暗号化です。

**守りたい脅威:**

- 物理ディスクの盗難
- ストレージへの直接アクセス
- バックアップメディアの紛失

**考慮点:**

- ほとんどのクラウドサービスでは追加コストなしで利用可能
- パフォーマンスへの影響は通常軽微
- コンプライアンス要件を満たすために必須の場合が多い

### 転送時の暗号化 (Encryption in Transit)

データが移動している状態での暗号化です。

**守りたい脅威:**

- ネットワーク上の盗聴
- 中間者攻撃 (MITM)
- 通信内容の改ざん

**考慮点:**

- TLS 1.2以上を使用（TLS 1.0/1.1は非推奨）
- 証明書の有効期限管理
- 内部通信も暗号化を検討（ゼロトラストの観点）

## 鍵管理の重要性

### 暗号化よりも鍵管理が難しい理由

暗号化アルゴリズム自体は十分に安全です。問題はほとんどの場合、鍵管理にあります:

- 鍵をどこに保存するか
- 誰が鍵にアクセスできるか
- 鍵が漏洩した場合どうするか
- 鍵をどのように更新するか

「暗号化しています」だけでは不十分で、鍵管理が適切でなければ暗号化の意味がありません。

### 鍵のライフサイクル管理

鍵には以下のライフサイクルがあります:

1. **生成**: 十分なエントロピーで安全に生成
2. **保存**: 安全な場所に保存（HSM、KMSなど）
3. **配布**: 必要な場所に安全に配布
4. **使用**: 適切なアクセス制御のもとで使用
5. **ローテーション**: 定期的に新しい鍵に更新
6. **破棄**: 不要になった鍵を安全に破棄

### 鍵のローテーション戦略

鍵を定期的に更新する理由:

- 漏洩した場合の影響範囲を限定
- コンプライアンス要件への対応
- 暗号解読リスクの軽減

**ローテーションの考慮点:**

- 自動ローテーションの活用
- 古い鍵で暗号化されたデータの再暗号化
- アプリケーションへの影響の最小化

### エンベロープ暗号化

データ暗号化鍵（DEK）を別の鍵（KEK）で暗号化する方式です。

```
データ → DEKで暗号化 → 暗号化されたデータ
DEK → KEKで暗号化 → 暗号化されたDEK

保存: 暗号化されたデータ + 暗号化されたDEK を一緒に保存
別管理: KEKだけをKMS等で厳重に管理
```

**AWS KMSの場合:**

AWS KMSはこのエンベロープ暗号化を採用しています。S3やEBSなどのサービスと連携する際、KMSキー（KEK）でデータキー（DEK）を暗号化し、暗号化されたデータキーはオブジェクトのメタデータとして保存されます。平文のDEKはメモリ内でのみ使用され、使用後は即座に削除されます。

**利点:**

- 大量のデータを効率的に暗号化
- 鍵のローテーションが容易（KEKだけ更新すればよい）
- KEKだけを厳重に管理すればよい

## AWS環境での実装

### IAMの設計原則

AWS IAMを使用する際の基本原則:

**1. rootユーザーの使用を最小化する**

- MFAを設定して厳重に保護
- 日常業務には使用しない
- アカウント設定変更など、rootでしかできない操作に限定

**2. IAMユーザーよりIAMロールを優先**

- 長期的な認証情報（アクセスキー）は避ける
- EC2、Lambda等にはIAMロールを使用
- 一時的な認証情報を活用

**3. ポリシーは最小権限で**

- マネージドポリシーから始めて、必要に応じてカスタマイズ
- `*` （ワイルドカード）の使用は慎重に
- Conditionを活用して条件を限定

### AWS KMSの役割

AWS Key Management Service (KMS) は鍵管理を簡素化します:

- 鍵の生成、保存、ローテーションを自動化
- アクセス制御をIAMと統合
- 監査ログ（CloudTrail）との連携
- 多くのAWSサービスとネイティブ統合

**KMSキーの種類:**

| 種類 | 管理者 | ユースケース |
|---|---|---|
| AWS管理キー | AWS | 手軽に始めたい場合 |
| カスタマー管理キー | ユーザー | 細かい制御が必要な場合 |
| 外部キー | ユーザー | オンプレミスとの連携 |

### よくある失敗パターン

**1. 過剰な権限の付与**

```
❌ "Action": "*", "Resource": "*"
✅ 必要なアクションとリソースのみを明示
```

**2. アクセスキーの使用**

```
❌ IAMユーザーのアクセスキーを発行して使用
✅ IAMロールと一時的な認証情報を使用
```

**3. MFAの未設定**

```
❌ MFAなしでアカウントを運用
✅ すべてのアカウントにMFAを設定
```

**4. 暗号化の未有効化**

```
❌ S3バケットのデフォルト暗号化が無効
✅ デフォルト暗号化を有効化
```

**5. 権限の放置**

```
❌ 退職者のアカウントが残存（フェデレーション認証未使用の場合）
✅ 定期的な権限レビューと削除プロセス
```

## まとめ

アクセス制御とデータ保護の要点:

1. **認証と認可を区別する**: 両方が適切に実装されて初めてセキュリティが確保される
2. **MFAを導入する**: すべてのアカウントで必須
3. **最小権限を実践する**: 必要な権限だけを、必要な期間だけ
4. **暗号化の限界を理解する**: 鍵管理が暗号化の肝
5. **定期的に見直す**: 権限は時間とともに陳腐化する

[ネットワーク防御を学ぶ →](network-defense.md){ .md-button .md-button--primary }
