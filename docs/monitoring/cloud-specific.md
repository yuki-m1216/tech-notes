# クラウド特有の設計

クラウド環境におけるモニタリング・アラート設計では、オンプレミスとは異なる考え方が必要です。

## クラウドの特性とモニタリング

### 1. 動的なリソース変更

**特性:**

クラウドでは、Auto Scalingにより自動的にリソースが増減します。

**モニタリングへの影響:**

- 固定された閾値だけでは不十分
- リソース数の変動を考慮した監視が必要
- スケール失敗の検知が重要

**アラート設計例:**

```
❌ 悪い例: EC2インスタンスが2台未満 → Critical
（Auto Scalingでスケールダウンしただけで誤検知）

✅ 良い例:
- Auto Scaling グループの Desired Capacity と実際のインスタンス数が一致しない → Critical
- Auto Scaling アクティビティの失敗 → Critical
```

### 2. マネージドサービスの活用

**特性:**

RDS、Lambda、DynamoDBなどのマネージドサービスでは、インフラの詳細は隠蔽されています。

**モニタリングへの影響:**

- OS レベルのメトリクスは取得できない（または不要）
- サービス固有のメトリクスを監視する
- サービスレベルでの健全性を重視

**監視対象の違い:**

| 環境 | 監視対象 |
|------|---------|
| オンプレミス | OS メトリクス（CPU、メモリ、ディスク）、プロセス監視 |
| クラウド（マネージド） | サービスメトリクス（接続数、レイテンシ、エラー率） |

**例: データベース監視**

```
オンプレミス:
- OS レベルのCPU、メモリ
- ディスクI/O
- PostgreSQLプロセスの状態

RDS:
- DatabaseConnections
- CPUUtilization（RDSが提供するメトリクス）
- ReadLatency / WriteLatency
- FreeableMemory
```

### 3. 従量課金とコスト最適化

**特性:**

使用した分だけ課金されるため、リソース使用量はコストに直結します。

**モニタリングへの影響:**

- コストの異常な増加も監視対象
- リソースの無駄遣いを検知
- プロジェクトの予算規模に応じて優先度を調整

**アラート設計例:**

```
コスト監視の重要性:
- 資金が限られているプロジェクトでは、コスト超過は深刻な問題
- ユーザー影響はないが、ビジネスへの影響は大きい
- プロジェクトの特性に応じて、InfoからWarningまで柔軟に設定

推奨設定:
- 月次コストが予算の80%超過 → Warning または Info（プロジェクト特性による）
- 日次コストが前日比で2倍 → Warning
- 特定リソースの異常なコスト増加 → Warning

※ ユーザー影響はないため即時対応は不要だが、定期的な確認は必須
```

### 4. リージョンとアベイラビリティゾーン

**特性:**

複数のAZにリソースを分散することで、高可用性を実現します。

**モニタリングへの影響:**

- AZ単位での監視が必要
- 一つのAZの障害を検知
- ただし、他のAZが正常なら全体としてはサービス継続

**アラート設計例:**

```
✅ 推奨:
- 全AZでインスタンスがUnhealthy → Critical（即時対応）
- 特定AZのインスタンスがUnhealthy（他は正常） → Warning（基本は週次レビュー時確認）

Warningレベルの理由:
- 他のAZが正常なため、ユーザー影響は最小限
- エンジニアが即座に起こせるアクションが少ない（AZ障害はAWS側で復旧を待つ）

ただし、システム特性により即座の対応が必要なケース:
- 2AZ構成で1AZ障害 → 残り1AZに全負荷が集中
- ピーク時間帯の障害 → キャパシティ不足の可能性
- 冗長性が低い設計 → 即座にキャパシティを増やす必要

→ システムの負荷状況や冗長性設計を考慮し、適切なアラートレベルを設定
```

### 5. サーバーレスアーキテクチャ

**特性:**

Lambdaなどのサーバーレスでは、サーバーの管理が不要です。

**モニタリングへの影響:**

- インフラの監視は不要
- アプリケーションメトリクスに集中
- コールドスタート、タイムアウト、スロットリングなどサーバーレス特有の問題を監視

**監視対象:**

```
Lambda:
- Errors（エラー数） → ユーザー影響あり
- Throttles（スロットリング） → ユーザー影響あり
- Duration（実行時間） → タイムアウトの予兆検知
- ConcurrentExecutions（同時実行数） → スロットリングの予兆検知
- Iterator Age（Kinesis/DynamoDB Streamsの場合） → 処理遅延の検知

従来のサーバー監視は不要:
- CPU使用率
- ディスクI/O
```

## クラウド特有のアラート設計パターン

### パターン1: Auto Scaling連動

**目的**: スケーリングが正常に機能しているか確認

```
監視項目:
- Auto Scaling アクティビティの失敗 → Critical
- Desired Capacity と実際のインスタンス数の不一致 → Critical
- CPU 使用率が高いがスケールアウトしていない → Warning

理由: Auto Scalingが機能していれば、CPU高騰は一時的で問題ない
```

### パターン2: マネージドサービスの制限

**目的**: サービス制限（Quota）に達する前に検知

```
監視項目:
- RDS 接続数が最大接続数の95%超過 → Critical
- Lambda 同時実行数が制限の80%超過 → Warning
- DynamoDB スロットリング発生 → Critical（ユーザー影響あり）

理由: 制限に達するとサービスが停止する
```

### パターン3: マルチAZ構成

**目的**: 高可用性構成の健全性確認

```
監視項目:
- ALB: 全ターゲットUnhealthy → Critical
- ALB: 特定AZのターゲットがUnhealthy（他は正常） → Warning

Warningレベルの基本的な考え方:
- 一部AZの障害は全体への影響が限定的
- エンジニアが即座に起こせるアクションが少ない（AWSの復旧を待つ）
- 基本は週次レビューで傾向を確認

ただし、システム特性により判断が必要:
- 2AZ構成の場合は即座の対応が必要な可能性
- ピーク時間帯は残りAZだけでは処理しきれない可能性
- 冗長性設計とトラフィック状況を考慮して、アラートレベルを調整
```

### パターン4: サーバーレス特有

**目的**: サーバーレス特有の問題を検知

```
監視項目:
- Lambda タイムアウト発生 → Critical（ユーザー影響あり）
- Lambda エラー（Out of Memory含む） → Critical（ユーザー影響あり）
- Lambda コールドスタート時間が長い → Info（ダッシュボード確認）
- Lambda スロットリング発生 → Critical
- Step Functions 実行失敗 → Critical

理由: タイムアウトやスロットリングはユーザー影響が大きい
```

## オンプレミスとの比較

| 観点 | オンプレミス | クラウド（AWS） |
|------|-------------|----------------|
| **リソース変更** | 手動、計画的 | 自動、動的（Auto Scaling） |
| **監視対象** | OS、ミドルウェア、アプリ | サービスメトリクス、アプリ |
| **障害対応** | ハードウェア交換、再起動 | サービス再起動、スケーリング |
| **高可用性** | クラスタリング、手動設定 | Multi-AZ、自動フェイルオーバー |
| **コスト** | 固定（設備投資） | 従量課金 |

## クラウドモニタリングのベストプラクティス

### 1. サービス固有のメトリクスを理解する

各AWSサービスが提供するメトリクスを理解し、適切に監視します。

**例: Lambda**
- Errors: エラー数
- Throttles: スロットリング数
- Duration: 実行時間

### 2. Auto Scalingを信頼する

適切にAuto Scalingが設定されていれば、CPU 80%は正常な動作です。

```
✅ CPU 80% → Warning（週次レビュー時確認）
✅ CPU 90% かつ Auto Scaling失敗 → Critical
```

### 3. マネージドサービスの恩恵を受ける

OS レベルの監視に時間を費やすのではなく、アプリケーションレベルの監視に集中します。

### 4. コスト監視の重要性

コスト超過はビジネスへの影響が大きいため、プロジェクトの特性に応じて適切に監視します。

```
✅ 資金が限られているプロジェクト: WarningまたはInfo（定期確認）
✅ 週次/月次レビューで必ず確認
✅ 予算超過の予兆を早期に検知
```

### 5. システム特性を考慮したアラート設計

マルチAZ構成の一部AZ障害でも、冗長性設計や負荷状況によっては即座の対応が必要です。

```
✅ 高冗長性（3AZ以上）: Warning（週次レビュー時確認）
✅ 低冗長性（2AZ）: CriticalまたはWarning（即座の判断が必要な可能性）
✅ ピーク時間帯: 即座にキャパシティ調整を検討
```

## まとめ

- クラウドは動的なリソース変更が前提、固定閾値だけでは不十分
- マネージドサービスではサービス固有のメトリクスを監視
- Auto Scalingが正常なら、リソース使用率の上昇は問題ない
- マルチAZ構成の一部AZ障害は基本的にWarningだが、システム特性により即座の対応が必要な場合もある
- コスト監視はプロジェクトの特性に応じて重要度を調整し、定期的な確認が必須
- サーバーレスではインフラ監視は不要、アプリケーションメトリクスに集中
- システムの冗長性設計と負荷状況を考慮して、適切なアラートレベルを設定
